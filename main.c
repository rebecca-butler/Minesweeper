#include <cmsis_os2.h>
#include <lpc17xx.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include "GLCD.h"
#include <time.h>

// BITMAPS
uint16_t cursor[16] = {
    0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000
};

uint16_t blank[16] = {
    0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff
};

uint16_t blue[16] = {
    0x0fff, 0x0fff, 0x0fff, 0x0fff, 
    0x0fff, 0x0fff, 0x0fff, 0x0fff, 
    0x0fff, 0x0fff, 0x0fff, 0x0fff, 
    0x0fff, 0x0fff, 0x0fff, 0x0fff
};

uint16_t flag[400] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xf800, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xf800, 0xf800, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xf800, 0xf800, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff
};

uint16_t mine[400] = {
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff
};

uint16_t smiley1[289] = {
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 
    0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0xffe0, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff
};

uint16_t blank2[289] = {
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff
};

uint16_t one[11] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

uint16_t two[77] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0x0000, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

uint16_t three[77] = {
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0xffff, 0x0000, 
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

//---------initizalize variables-----------//
//timer variables
int sec = 0;
int min = 0;
int zero = 0;

//cursor initial positions
unsigned int jx = 21;
unsigned int jy = 24;
unsigned int jxOld = 21;
unsigned int jyOld = 24;
int spd = 26; //grid offset

int mode = 0; // mine = 0, flag = 1;
int playerStatus = 0;

//number of mines remaining
int numMines = 9;
int numMinesPrev = 9;

#define BOARD_SIZE 9+2

//board arrays
char playerBoard[BOARD_SIZE][BOARD_SIZE];
char board[BOARD_SIZE][BOARD_SIZE];

//grid position
int xPos = 1;
int yPos = 1;
int xPosOld = 1;
int yPosOld = 1;


//-------------FUNCTIONS-----------------//
//convert int to unsigned char string
unsigned char * itos(int n) {
	static char str[10];
	sprintf(str, "%d", n);
	return (unsigned char*) str;
}

// Generate 9 mines within board size area
void create_mines()
{     
    for (int i = 1; i < 10; i++)
    {
        int random = rand() % (BOARD_SIZE-2) + 1;
        board[random][i] = '*';
    }
 
}

//check current square for surrounding mines
int check_for_nearby_mines(int row, int col)
{
    int mines = 0;
		
		// Check if current square is a mine
		if (board[row][col] == '*') {
			return -1;
		}
	
    // Check up, down, left, right.
    if(board[row - 1][col] == '*')
        mines++;
    if(board[row + 1][col] == '*')
        mines++;
    if(board[row][col - 1] == '*')
        mines++;
    if(board[row][col + 1] == '*')
        mines++;
 
    // Check all diagonal directions
    if(board[row - 1][col + 1] == '*')
        mines++;
    if(board[row - 1][col - 1] == '*')
        mines++;
    if(board[row + 1][col + 1] == '*')
        mines++;
    if(board[row + 1][col - 1] == '*')
        mines++;
 
    return mines;
}

void cleartonearbymines(int row, int col)
{
	//check nearbymines for curr pos
	int nMines = check_for_nearby_mines(row, col);
	if (nMines == 0) {
		//change square color
		playerBoard[row][col] = ' ';
		
		//W
		if (check_for_nearby_mines(row-1, col) == 0 && row-1 >= 1 && playerBoard[row-1][col] != ' ') {
			playerBoard[row-1][col] = ' ';
		}
		//E
		if (check_for_nearby_mines(row+1, col) == 0 && row+1 <= 9 && playerBoard[row+1][col] != ' ') {
			playerBoard[row+1][col] = ' ';
		}
		//S
		if (check_for_nearby_mines(row, col+1) == 0 && col+1 <= 9 && playerBoard[row][col+1] != ' ') {
			playerBoard[row][col+1] = ' ';
		}
		//N
		if (check_for_nearby_mines(row, col-1) == 0 && col-1 >= 1 && playerBoard[row][col-1] != ' ') {
			playerBoard[row][col-1] = ' ';
		}
		
	}
	else if (nMines == 1) {
		playerBoard[col][row] = '1';
		printf("1");
	}
	else if (nMines == 2) {
		playerBoard[col][row] = '2';
		printf("2");
	}
	else if (nMines == 1) {
		playerBoard[col][row] = '3';
		printf("3");
	}
}



//print board to PuTTy
void printBoard(char b[][BOARD_SIZE]) {
	for(int i = 0; i < BOARD_SIZE; i++) {
		for (int j = 0; j < BOARD_SIZE; j++) {
			printf("%c", b[j][i]);
		}
		printf("\n");
	}
	printf("\n");
}

//clear surrounding squares bc not part of board
void clearEdge() {
	for(int i = 0; i < BOARD_SIZE; i++)
			for(int j = 0; j < BOARD_SIZE; j++)
					if(i == 0 || i == BOARD_SIZE - 1)
							board[i][j] = ' ';

	for(int j = 0; j < BOARD_SIZE; j++)
			for(int i = 0; i < BOARD_SIZE; i++)
					if(j == 0 || j == BOARD_SIZE - 1)
							board[i][j] = ' ';
}

//Generate numbers surrounding mines
void genNums() {
	for(int i = 0; i < BOARD_SIZE; i++) {
		for (int j = 0; j < BOARD_SIZE; j++) {
			if (board[i][j] != '*') {
				int n = check_for_nearby_mines(i, j);
				if (n == 1) {
					board[i][j] = '1';
				}
				else if (n == 2) {
					board[i][j] = '2';
				}
				else if (n == 3) {
					board[i][j] = '3';
				}
			}
		}
	}
}

//initialize board
void initBoard() {
	//fill board with free squares
	for(int i = 0; i < BOARD_SIZE; i++) {
		for (int j = 0; j < BOARD_SIZE; j++) {
			board[i][j] = 'o';
			playerBoard[i][j] = 'o';
		}
	}
	
	create_mines();
	printBoard(board);
	
	clearEdge();
	printBoard(board);
	
	genNums();
	clearEdge();
	printBoard(board);
}

//fill in background of squares with white
void blankBG(int row, int col) {
	for (int i = 0; i < 6; i++) {
		for (int j = 0; j < 6; j++) {
			GLCD_Bitmap(row*26+1+i*4, col*26+4+j*4, 4, 4, (unsigned char*) blank);
		}
	}
}
//---------------THREADS--------------//

// ----- LCD ----- //
void lcd (void *argument) {
	
	//Setup LCD
	GLCD_Clear(White);
	GLCD_SetBackColor(White);
	GLCD_SetTextColor(Black);
	
	GLCD_SetTextColor(0x0FFF);
	for(int i = 0; i < 234; i++) {
		for(int j = 3; j < 238; j++) {
			GLCD_PutPixel(i, j);
		}
	}
	GLCD_SetTextColor(Black);
	
	//240x320 grid
	for(int i = 0; i < 240; i += 26) {
		for(int j = 3; j < 238; j++) {
			GLCD_PutPixel(i, j);
		}
	}
	for(int m = 3; m < 240; m += 26) {
		for(int n = 0; n < 234; n++) {
			GLCD_PutPixel(n, m);
		}
	}
	
	//timer setup
	unsigned char t[] = "time";
	GLCD_DisplayString(1, 15, 1, t);
	
	unsigned char t2[] = ":";
	GLCD_DisplayString(2, 17, 1, t2);
	
	int smileyPos = 200;
	int pos = 0;
	
	while (1) {
		//timer
		if (sec < 10) { //seconds
			unsigned char *z = itos(zero);
			GLCD_DisplayString(2, 18, 1, z);
			unsigned char *s = itos(sec);
			GLCD_DisplayString(2, 19, 1, s);
		}
		else {
			unsigned char *s = itos(sec);
			GLCD_DisplayString(2, 18, 1, s);
		}
		
		if (min < 10) { //minutes
			unsigned char *z = itos(zero);
			GLCD_DisplayString(2, 15, 1, z);
			unsigned char *m = itos(min);
			GLCD_DisplayString(2, 16, 1, m);
		}
		else {
			unsigned char *m = itos(min);
			GLCD_DisplayString(2, 15, 1, m);
		}
		
		//smiley animation
		if (sec % 1 == 0) {
			if (smileyPos > 140 && pos < 6) {
				smileyPos -= 10;
				pos++;
			}
			else if (smileyPos == 200) {
				pos = 0;
			}
			else{
				smileyPos += 10;
			}
		}
		
		//smiley animation updating
		if (pos < 6) {
			GLCD_Bitmap(270, smileyPos+10, 17, 17, (unsigned char*) blank2);
		}
		else {
			GLCD_Bitmap(270, smileyPos-10, 17, 17, (unsigned char*) blank2);
		}
		
		//draw smiley
		GLCD_Bitmap(270, 150, 17, 17, (unsigned char*) blank2);
		GLCD_Bitmap(270, smileyPos, 17, 17, (unsigned char*) smiley1);
		
		//cursor
		if (playerBoard[xPosOld][yPosOld] == 'o') {
			GLCD_Bitmap(jxOld, jyOld, 4, 4, (unsigned char*) blue);
		}
		else if (playerBoard[xPosOld][yPosOld] == 'F'){
			GLCD_Bitmap(jxOld, jyOld, 4, 4, (unsigned char*) cursor);
		}
		else {
			GLCD_Bitmap(jxOld, jyOld, 4, 4, (unsigned char*) blank);
		}
		GLCD_Bitmap(jx, jy, 4, 4, (unsigned char*) cursor);
		
		//mode indicator
		if (mode == 0) { //mine
			GLCD_Bitmap(270, 90, 20, 20, (unsigned char*) mine);
		}
		else { //flag
			GLCD_Bitmap(270, 90, 20, 20, (unsigned char*) flag);
		}
		
		//square number and flag display
		for(int xPos = 0; xPos < 9; xPos++) {
			for (int yPos = 0; yPos < 9; yPos++) {
				if (playerBoard[xPos+1][yPos+1] == 'f') {
					blankBG(xPos, yPos);
					GLCD_Bitmap(xPos*26+3, yPos*26+8, 20, 20, (unsigned char*) flag);
					playerBoard[xPos+1][yPos+1] = 'F';
				}
				else if (playerBoard[xPos+1][yPos+1] == '1') {
					blankBG(xPos, yPos);
					GLCD_Bitmap(xPos*26+13, yPos*26+10, 1, 11, (unsigned char*) one);
					playerBoard[xPos+1][yPos+1] = 'O';
				}
				else if (playerBoard[xPos+1][yPos+1] == '2') {
					blankBG(xPos, yPos);
					GLCD_Bitmap(xPos*26+10, yPos*26+10, 7, 11, (unsigned char*) two);
					playerBoard[xPos+1][yPos+1] = 't';
				}
				else if (playerBoard[xPos+1][yPos+1] == '3') {
					blankBG(xPos, yPos);
					GLCD_Bitmap(xPos*26+10, yPos*26+10, 7, 11, (unsigned char*) three);
					playerBoard[xPos+1][yPos+1] = 'T';
				}
				else if (playerBoard[xPos+1][yPos+1] == ' ') {
					blankBG(xPos, yPos);
					playerBoard[xPos+1][yPos+1] = 'b';
				}
			}
		}
		
		// if player wins or dies, break the loop
		if (playerStatus == -1 || playerStatus == 9) {
			break;
		}
	}
	//if player dies
	if (playerStatus == -1) {
		GLCD_Clear(White);
		unsigned char msg[] = "GAME OVER";
		GLCD_DisplayString(4, 5, 1, msg);
		unsigned char msg2[] = "Press the RESET button to play again";
		GLCD_DisplayString(20, 8, 0, msg2);
	}
	//if player wins
	else if (playerStatus == 9) {
		GLCD_Clear(White);
		GLCD_Bitmap(150, 160, 17, 17, (unsigned char*) smiley1);
		unsigned char msg[] = "GAME WON";
		GLCD_DisplayString(4, 6, 1, msg);
	}
}

// ----- TIMER ----- //
void timer (void *argument) {
	while (1) {
		osDelay(1000);
		sec++;
		if (sec == 60) {
			min++;
			sec = 0;
		}
	}
}

// ----- JOYSTICK ----- //
void joystick (void *argument) {
	while (1) {
		//UP
		if (!(LPC_GPIO1->FIOPIN & 0x800000) && jy > spd) {
			jxOld = jx;
			jyOld = jy;
			
			xPosOld = xPos;
			yPosOld = yPos;
			
			yPos -= 1;
			jy -= spd;
			osDelay(100);
		}

		//RIGHT
		if (!(LPC_GPIO1->FIOPIN & 0x1000000) && jx < 240-spd) {
			jxOld = jx;
			jyOld = jy;
			
			xPosOld = xPos;
			yPosOld = yPos;
			
			xPos += 1;
			
			jx += spd;
			osDelay(100);
		}
		
		//DOWN
		if (!(LPC_GPIO1->FIOPIN & 0x2000000) && jy < 240-spd) {
			jxOld = jx;
			jyOld = jy;
			
			xPosOld = xPos;
			yPosOld = yPos;
			
			yPos += 1;
			
			jy += spd;
			osDelay(100);
		}
		
		//LEFT
		if (!(LPC_GPIO1->FIOPIN & 0x4000000) && jx > spd) {
			jxOld = jx;
			jyOld = jy;
			
			xPosOld = xPos;
			yPosOld = yPos;
			
			xPos -= 1;
			
			jx -= spd;
			osDelay(100);
		}
		//PUSHBUTTON
		if (!(LPC_GPIO1->FIOPIN & 0x100000)) {
			//set flag/dig
			if (mode == 1) {
				if (board[xPos][yPos] == '*' && playerBoard[xPos][yPos] != 'f') {
					playerStatus++;
					numMines--;
				}
				playerBoard[xPos][yPos] = 'f';
			}
			else if (mode == 0) { // else if mode is mines
				char c = board[xPos][yPos];
				// if clicked on a mine
				if (c == '*') {
					playerStatus = -1;
				}
				//else if square is a number, display
				else if (c == '1' || c == '2' || c == '3') {
					playerBoard[xPos][yPos] = c;
				}
				//else (blank) keep checking surrounding squares until reach number cells
				else {
					cleartonearbymines(xPos, yPos);
				}
			}
			osDelay(200);
		}
		
	}
}

// ----- PUSHBUTTON ----- //
void pushbutton (void *argument) {
	while (1) {
		if (!(LPC_GPIO2->FIOPIN & 0x400)) {
			if (mode == 0) {
				mode = 1;
				osDelay(250);
			}
			else {
				mode = 0;
				osDelay(250);
			}
		}
	}
}

// ----- LEDs ----- //
void LED (void *argument) {
	LPC_GPIO1->FIODIR |= 0xB0000000;
	LPC_GPIO2->FIODIR |= 0x7C;
	while (1) {
		uint8_t b = numMines;
		
		//clear LEDS without flashing
		if (numMinesPrev != numMines) {
			LPC_GPIO1->FIOCLR |= 0xB0000000;
			LPC_GPIO2->FIOCLR |= 0x7C;
			numMinesPrev = numMines;
			osDelay(200);
		}
		
		//set LEDs
		if (b & 0x01) {
			LPC_GPIO2->FIOSET |= 0x40;
		}
		if (b & 0x02) {
			LPC_GPIO2->FIOSET |= 0x20;
		}
		if (b & 0x04) {
			LPC_GPIO2->FIOSET |= 0x10;
		}
		if (b & 0x08) {
			LPC_GPIO2->FIOSET |= 0x08;
		}
		if (b & 0x10) {
			LPC_GPIO2->FIOSET |= 0x04;
		}
		if (b & 0x20) {
			LPC_GPIO1->FIOSET |= 0x80000000;
		}
		if (b & 0x40) {
			LPC_GPIO1->FIOSET |= 0x20000000;
		}
		if (b & 0x80) {
			LPC_GPIO1->FIOSET |= 0x10000000;
		}
	}
}

//main func
int main (void) {
	//initialization
	GLCD_Init();
	osKernelInitialize();
	initBoard();
	
	//create threads
	osThreadNew(lcd, NULL, NULL);
	osThreadNew(timer, NULL, NULL);
	osThreadNew(joystick, NULL, NULL);
	osThreadNew(pushbutton, NULL, NULL);
	osThreadNew(LED, NULL, NULL);
	osKernelStart();
	
	while(1);
}